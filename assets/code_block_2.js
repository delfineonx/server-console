{const _SC={establish:null,install:{fn:()=>{},done:true,cache:{}},ranks:{create:null,delete:null,list:null,exist:null,get:null,add:null,remove:null},perms:{getRank:null,setRank:null,has:null,get:null,add:null,remove:null,clear:null},tick:null,onPlayerJoin:null,onPlayerLeave:null,playerCommand:null,commands:Object.create(null),playerNameById:Object.create(null),playerIdByName:Object.create(null),playerDbIdById:Object.create(null),playerIdByDbId:Object.create(null),parse:null,split:null,resolveNames:null,playersTokenError:null,resolveOneName:null,onePlayerTokenError:null,tokenError:null,_playerDataById:Object.create(null),_operationId:0};const _TS=globalThis.TS;const _PT=globalThis.PT;const _consoleInfoHeader=""+"\u2580\u2584\u2580\u2584\u2580 Server Console \u2580\u2584\u2580\u2584\u2580\n"+"         \u300c \u2726 delfineonx \u2726 \u300d\n"+"\n";const _consoleInfoFooter=""+"\u30fb\u30fb\u30fb\u30fb\u30fb Parameters \u30fb\u30fb\u30fb\u30fb\u30fb\n"+"- [players]:\n"+"  \`all\` \u2014 everyone in lobby;\n"+"  \`me\` \u2014 player who executes the command;\n"+"  \`-me\` \u2014 everyone except one who executes the command;\n"+"  \`name1\` \u2014 player with \`name1\`;\n"+"  \`-name1\` \u2014 everyone except player with \`name1\`;\n"+"  \`[name1 name2]\` \u2014 players with specified names;\n"+"  \`[-name1 -name2]\` \u2014 everyone except specified players.\n"+"  NOTE: supports partial names with length of \`>= 4\` characters.\n"+"\n"+"- others:\n"+"  use as \`value\` or \`[value with spaces]\`.\n"+"\n"+"- default values:\n"+"  use dot symbol (`.`) for default values,\n"+"  or omit parameters from the end.\n";const _commands=_SC.commands;const _nameById=_SC.playerNameById;const _idByName=_SC.playerIdByName;const _dbidById=_SC.playerDbIdById;const _idByDbId=_SC.playerIdByDbId;const _dataById=_SC._playerDataById;const _maskByRank=Object.create(null);let _nameByMaskIndex=[];const _install=_SC.install;const _ranks=_SC.ranks;const _perms=_SC.perms;let _maskIndex=0;let _established=true;_SC.establish=()=>{_nameByMaskIndex.length=0;_maskIndex=0;_established=false};const _UNESCAPE=/\\([\\\[\]nrt])/g;const _unescapeRepl=(_match,char)=>{if(char==="n")return"\n";if(char==="r")return"\r";if(char==="t")return"\t";return char};const _parse=_SC.parse=str=>{const tokens=[];const n=str.length;let state=0;let start=0;let hasBackslash=0;let escaped=0;for(let i=0;i<n;i++){const charCode=str.charCodeAt(i);if(state===0){if(charCode<=32){continue}if(charCode===91){state=2;start=i+1;hasBackslash=0;escaped=0}else{state=1;start=i;hasBackslash=charCode===92}continue}if(state===1){if(charCode<=32){let token=str.slice(start,i);if(hasBackslash){token=token.replace(_UNESCAPE,_unescapeRepl)}tokens.push(token);state=0}else if(charCode===92){hasBackslash=1}continue}if(escaped){escaped=0;continue}if(charCode===92){hasBackslash=1;escaped=1;continue}if(charCode===93){let token=str.slice(start,i);if(hasBackslash){token=token.replace(_UNESCAPE,_unescapeRepl)}tokens.push(token);state=0}}if(state===1||state===2){let token=str.slice(start,n);if(hasBackslash){token=token.replace(_UNESCAPE,_unescapeRepl)}tokens.push(token)}return tokens};const _split=_SC.split=str=>{const tokens=[];const n=str.length;let state=0;let start=0;for(let i=0;i<n;i++){const charCode=str.charCodeAt(i);if(state===0){if(charCode<=32){continue}state=1;start=i;continue}if(charCode<=32){tokens.push(str.slice(start,i));state=0}}if(state===1){tokens.push(str.slice(start,n))}return tokens};const _maskToNames=perms=>{const names=[];for(let word=0;word<2;word++){let mask=perms[word]>>>0;while(mask){const lsb=mask&-mask;const bit=31-Math.clz32(lsb);names.push(_nameByMaskIndex[(word<<5)+bit]);mask^=lsb}}return names};const _makeConsoleInfoCommands=()=>{let info = "\u30fb\u30fb\u30fb\u30fb\u30fb Commands \u30fb\u30fb\u30fb\u30fb\u30fb\n";for(const name in _commands){const command=_commands[name];const _default=command._default;let defaults="| ";for(const tokenKey in _default){const tokenValue=_default[tokenKey];if(typeof tokenValue==="string"){defaults+=tokenKey+':"'+tokenValue+'" | '}else{defaults+=tokenKey+":"+tokenValue+" | "}}info+="- "+command._desc+"\n   "+defaults+"\n"}return info};const _resolvePlayerNames=_SC.resolveNames=(userId,str)=>{if(str==null){return[[],[],[]]}const tokens=_split(str);const include={};const exclude={};let includeAny=0,includeAll=0,excludeAny=0,excludeAll=0;const targets=[];const unspecified=[];const invalid=[];const playerIds=globalThis.PT.getPlayerIdsUnsafe();const numPlayers=playerIds.length;for(let index=0;index<tokens.length;index++){let token=tokens[index];const isExclusive=token[0]==="-";if(isExclusive){token=token.slice(1)}if(token==="all"){if(isExclusive){excludeAll=1}else{includeAll=1}continue}if(token==="me"){if(isExclusive){exclude[userId]=1;excludeAny=1}else{include[userId]=1;includeAny=1}continue}let matchId=_idByName[token];let matchCount=0;if(matchId!==undefined){if(isExclusive){exclude[matchId]=1;excludeAny=1}else{include[matchId]=1;includeAny=1}continue}if(token.length<4){invalid.push(token);continue}for(let i=0;i<numPlayers;i++){const id=playerIds[i];const name=_nameById[id];if(name&&name.indexOf(token)!==-1){if(++matchCount>1){break}matchId=id}}if(matchCount===1){if(isExclusive){exclude[matchId]=1;excludeAny=1}else{include[matchId]=1;includeAny=1}}else if(!matchCount){invalid.push(token)}else{unspecified.push(token)}}if(!excludeAll){if(includeAll||!includeAny&&excludeAny){for(let i=0;i<numPlayers;i++){const id=playerIds[i];if(!exclude[id]){targets.push(id)}}}else{for(const id in include){if(!exclude[id]){targets.push(id)}}}}return[targets,unspecified,invalid]};const _playersTokenError=_SC.playersTokenError=(commandName,userId,resolvedIds)=>{if(resolvedIds[1].length>0){api.sendMessage(userId,'Server Console: "/'+commandName+'": Multiple players: '+resolvedIds[1].join(", "),{color:"#fcd373"})}if(resolvedIds[2].length>0){api.sendMessage(userId,'Server Console: "/'+commandName+'": Invalid players: '+resolvedIds[2].join(", "),{color:"#fcd373"})}if(resolvedIds[0].length===0){api.sendMessage(userId,'Server Console: "/'+commandName+'": No valid players found.',{color:"#fcd373"});return true}return false};_SC.resolveOneName=(userId,str)=>{if(str==null){return"2"}if(str==="me"){return userId}if(str==="all"){return"1"+str}let matchId=_idByName[str];let matchCount=0;if(matchId!==undefined){return matchId}if(str.length<4){return"0"+str}const playerIds=_PT.getPlayerIdsUnsafe();const numPlayers=playerIds.length;for(let i=0;i<numPlayers;i++){const id=playerIds[i];const name=_nameById[id];if(name&&name.indexOf(str)!==-1){if(++matchCount>1){break}matchId=id}}if(matchCount===1){return matchId}if(matchCount===0){return"0"+str}return"1"+str};_SC.onePlayerTokenError=(commandName,userId,resolvedOneId)=>{if(resolvedOneId[0]==="1"){api.sendMessage(userId,'Server Console: "/'+commandName+'": Multiple players: '+resolvedOneId.slice(1),{color:"#fcd373"});return true}else if(resolvedOneId[0]==="0"){api.sendMessage(userId,'Server Console: "/'+commandName+'": Invalid player: '+resolvedOneId.slice(1),{color:"#fcd373"});return true}else if(resolvedOneId[0]==="2"){api.sendMessage(userId,'Server Console: "/'+commandName+'": Valid player name required',{color:"#fcd373"});return true}return false};_SC.tokenError=(commandName,userId,condition,message)=>{if(condition){api.sendMessage(userId,'Server Console: "/'+commandName+'": '+message,{color:"#fcd373"});return true}return false};_ranks.create=(rankName,commandNames)=>{const perms=[0,0];for(let i=0,n=commandNames.length;i<n;i++){const command=_commands[commandNames[i]?.toLowerCase()];if(command){perms[command._word]|=command._bit}}_maskByRank[rankName]=perms};_ranks.delete=rankName=>{if(_maskByRank[rankName]){delete _maskByRank[rankName];return true}return false};_ranks.list=()=>{const names=[];for(const name in _maskByRank){names.push(name)}return names};_ranks.exist=rankName=>{return!!_maskByRank[rankName]};_ranks.get=rankName=>{const perms=_maskByRank[rankName];if(!perms){return null}return _maskToNames(perms)};_ranks.add=(rankName,commandNames)=>{let perms=_maskByRank[rankName];if(!perms){return false}perms=perms.slice();for(let i=0,n=commandNames.length;i<n;i++){const command=_commands[commandNames[i]?.toLowerCase()];if(command){perms[command._word]|=command._bit}}_maskByRank[rankName]=perms;return true};_ranks.remove=(rankName,commandNames)=>{let perms=_maskByRank[rankName];if(!perms){return false}perms=perms.slice();for(let i=0,n=commandNames.length;i<n;i++){const command=_commands[commandNames[i]?.toLowerCase()];if(command){perms[command._word]&=~command._bit}}_maskByRank[rankName]=perms;return true};_perms.getRank=playerDbId=>{const playerId=_idByDbId[playerDbId];if(!playerId){return null}return _dataById[playerId].rank};_perms.setRank=(playerDbId,rankName)=>{const playerId=_idByDbId[playerDbId];const rankPerms=_maskByRank[rankName];if(!playerId||!rankPerms){return false}const data=_dataById[playerId];data.perms=rankPerms.slice();data.rank=rankName;return true};_perms.has=(playerDbId,commandName)=>{const playerId=_idByDbId[playerDbId];const command=_commands[commandName?.toLowerCase()];if(!playerId||!command){return null}return!!(_dataById[playerId].perms[command._word]&command._bit)};_perms.get=playerDbId=>{const playerId=_idByDbId[playerDbId];if(!playerId){return null}return _maskToNames(_dataById[playerId].perms)};_perms.add=(playerDbId,commandNames)=>{const playerId=_idByDbId[playerDbId];if(!playerId){return false}const perms=_dataById[playerId].perms.slice();for(let i=0,n=commandNames.length;i<n;i++){const command=_commands[commandNames[i]?.toLowerCase()];if(command){perms[command._word]|=command._bit}}_dataById[playerId].perms=perms;return true};_perms.remove=(playerDbId,commandNames)=>{const playerId=_idByDbId[playerDbId];if(!playerId){return false}const perms=_dataById[playerId].perms.slice();for(let i=0,n=commandNames.length;i<n;i++){const command=_commands[commandNames[i]?.toLowerCase()];if(command){perms[command._word]&=~command._bit}}_dataById[playerId].perms=perms;return true};_perms.clear=playerDbId=>{const playerId=_idByDbId[playerDbId];if(!playerId){return false}_dataById[playerId].perms=[0,0];return true};_commands.console={_name:"console",_desc:"/console [players] [delay]",_default:{players:"me",delay:0},_cmd:function(userId,tokens){const command=this;const _default=command._default;const resolvedIds=_resolvePlayerNames(userId,tokens[1]===undefined||tokens[1]==="."?_default.players:tokens[1]);if(_playersTokenError(command._name,userId,resolvedIds)){return"Error"}const delay=(tokens[2]===undefined||tokens[2]==="."?_default.delay:tokens[2])|0;const groupId="SC"+ ++_SC._operationId;command._run(resolvedIds[0],delay,groupId);return groupId},_run:function(targetIds,delay,groupId){const mainInfo=_consoleInfoHeader+_makeConsoleInfoCommands();let i=0,n=targetIds.length;if(!delay){while(i<n){const playerId=targetIds[i];api.sendMessage(playerId,mainInfo,{color:"#84e0ff"});api.sendMessage(playerId,_consoleInfoFooter,{color:"#84e0ff"});i++}}else{_TS.run(()=>{while(i<n){const playerId=targetIds[i];if(_PT.checkValid[playerId]){api.sendMessage(playerId,mainInfo,{color:"#84e0ff"});api.sendMessage(playerId,_consoleInfoFooter,{color:"#84e0ff"})}i++}},delay,groupId)}}};_commands.cmdout={_name:"cmdout",_desc:"/cmdout [players] [enabled] [delay]",_default:{players:"me",enabled:false,delay:0},_cmd:function(userId,tokens){const command=this;const _default=command._default;const resolvedIds=_resolvePlayerNames(userId,tokens[1]===undefined||tokens[1]==="."?_default.players:tokens[1]);if(_playersTokenError(command._name,userId,resolvedIds)){return"Error"}const enabled=tokens[2]===undefined||tokens[2]==="."?_default.enabled:tokens[2]!=="false"&&tokens[2]!=="0";const delay=(tokens[3]===undefined||tokens[3]==="."?_default.delay:tokens[3])|0;const groupId="SC"+ ++_SC._operationId;command._run(resolvedIds[0],enabled,delay,groupId);return groupId},_run:function(targetIds,enabled,delay,groupId){let i=0,n=targetIds.length;if(!delay){while(i<n){_dataById[targetIds[i]].showCmdOut=enabled;i++}}else{_TS.run(()=>{while(i<n){const playerId=targetIds[i];if(_PT.checkValid[playerId]){_dataById[playerId].showCmdOut=enabled}i++}},delay,groupId)}}};_commands.cancel={_name:"cancel",_desc:"/cancel [commandGroupId] [delay]",_default:{commandGroupId:"-last executed per user-",delay:0},_cmd:function(userId,tokens){const command=this;const _default=command._default;let commandGroupId=tokens[1]===undefined||tokens[1]==="."?_dataById[userId].lastCmdGroupId:tokens[1];const delay=(tokens[2]===undefined||tokens[2]==="."?_default.delay:tokens[2])|0;const groupId="SC"+ ++_SC._operationId;command._run(commandGroupId,delay,groupId);return groupId},_run:function(commandGroupId,delay,groupId){if(!delay){_TS.stop(commandGroupId)}else{_TS.run(()=>{_TS.stop(commandGroupId)},delay,groupId)}}};_SC.tick=()=>{if(!_established){for(const name in _commands){const command=_commands[name];if(command._word==null){command._word=_maskIndex>>>5;command._bit=1<<(_maskIndex&31)>>>0;_nameByMaskIndex[_maskIndex]=name;_maskIndex++}}_established=true}if(!_install.done){try{_install.fn(_install.cache);_install.done=true}catch(error){_install.done=true;api.broadcastMessage("Server Console: Installation error: "+error.name+": "+error.message,{color:"#ff9d87"})}}};_SC.onPlayerJoin=playerId=>{const name=api.getEntityName(playerId);const dbid=api.getPlayerDbId(playerId);_nameById[playerId]=name;_idByName[name]=playerId;_dbidById[playerId]=dbid;_idByDbId[dbid]=playerId;_dataById[playerId]={showCmdOut:false,lastCmdGroupId:"SC0",rank:null,perms:[0,0]}};_SC.onPlayerLeave=playerId=>{const name=_nameById[playerId];const dbid=_dbidById[playerId];delete _nameById[playerId];delete _idByName[name];delete _dbidById[playerId];delete _idByDbId[dbid];delete _dataById[playerId]};_SC.playerCommand=(userId,input)=>{let tokens=_parse(input);const name=tokens[0]?.toLowerCase();const command=_commands[name];const data=_dataById[userId];let out=null;if(command){if(data.perms[command._word]&command._bit){try{out=command._cmd(userId,tokens)}catch(error){out="Error";api.sendMessage(userId,'Server Console: "/'+command._name+'" execution: '+error.name+": "+error.message,{color:"#ff9d87"})}if(out!=="Error"){data.lastCmdGroupId=out}}else{out="AccessDenied";api.sendMessage(userId,'Server Console: "/'+command._name+'": Access denied',{color:"#ff9d87"})}}if(data.showCmdOut){api.sendMessage(userId,out,{color:"#2eeb82"})}return out};globalThis.SC=_SC;void 0}

